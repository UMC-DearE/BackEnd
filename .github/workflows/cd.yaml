name: CD - Deploy to Production

# main 브랜치에 push 시 배포 파이프라인 실행
on:
  push:
    branches:
      - main

# 연속 push로 배포가 겹치지 않게 직렬화 (이전 배포 진행 중이면 취소)
concurrency:
  group: deare-prod-deploy
  cancel-in-progress: true

env:
  IMAGE_REPO: ${{ secrets.DOCKER_USERNAME }}/deare-backend

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # JDK 17 (Temurin) + Gradle 캐시로 빌드 속도 개선
      - name: Set up JDK 17 (Temurin) + Gradle cache
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "gradle"

      # 리눅스 러너 gradlew 실행권한
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # Spring Boot 빌드 (운영 배포 속도 위해 테스트는 스킵)
      - name: Build with Gradle
        run: ./gradlew clean build -x test

      # Docker Hub 로그인 (이미지 push 권한 확보)
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }} # Docker Hub Access Token

      # Buildx 준비 (캐시 / 빌드 - 푸시 액션 사용)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Docker 이미지 빌드 + 푸시
      # - latest: 항상 최신 운영 이미지
      # - github.sha: 배포 추적/롤백을 위한 커밋 고정 태그
      - name: Build & Push Docker image (latest + sha)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_REPO }}:latest
            ${{ env.IMAGE_REPO }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # EC2에 SSH 접속 -> 최신 이미지 pull -> compose 로 재기동
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}       # EC2 Public IPv4/DNS
          username: ${{ secrets.SERVER_USER }}   # ubuntu 또는 ec2-user
          key: ${{ secrets.SSH_PRIVATE_KEY }}    # pem 개인키 내용 전체
          script: |
            set -e

            # docker-compose.yaml 이 있는 디렉토리로 이동 (경로 세팅으로 인한 문제 조심)
            cd ${{ secrets.SERVER_PATH }}

            # 서버에서 최신 이미지 pull
            docker pull ${{ env.IMAGE_REPO }}:latest

            # compose로 컨테이너 재기동 (프로덕션용 설정 사용)
            docker compose -f docker-compose.prod.yaml down
            docker compose -f docker-compose.prod.yaml up -d --remove-orphans

            # 배포 결과 확인 (컨테이너 상태 출력)
            docker compose -f docker-compose.prod.yaml ps
